module.exports = {

  init: function() {
    var q = this;
    console.log('Ripple back-end initialised');
  },

  restModule: true,

  handlers: {

    getPatient: function(messageObj, finished) {
      var patientId = messageObj.params['0'];
      if (!patientId || patientId === '') {
        finished({error: 'Missing patient Id'});
        return;
      }

      var tmp = new this.documentStore.DocumentNode('tmp', [process.pid]);

      var resultObj = this.db.invoke_classmethod({
        class: 'Ripple.PatientServiceJSON',
        method: 'getPatient',
        arguments: [patientId]
      });
      var patient = tmp.getDocument(true, 1);

      finished(patient);
    },

    getPatientSummary: function(messageObj, finished) {

      var tmp = new this.documentStore.DocumentNode('tmp', [process.pid]);

      var resultObj = this.db.invoke_classmethod({
        class: 'Ripple.PatientServiceJSON',
        method: 'getPatientSummary',
        arguments: []
      });
      var results = tmp.getDocument(true, 1);
      var patients = [];
      var result;
      var patient;
      var date;
      var dd;
      var mm;
      var yy;
      var gender = {
        M: 'Male',
        F: 'Female'
      };
      for (var id in results) {
        result = results[id];
        result.nhsNumber = result.IHINumber;
        date = result.dateOfBirth;
        dd = date.substring(6);
        mm = date.substring(4, 6);
        yy = date.substring(0, 4);
        result.dateOfBirth = new Date(yy, mm, dd).getTime();
        result.department = result.Location;
        result.gender = gender[result.gender];
        result.id = result.ID;
      }

      finished(results);
    }
  }
};